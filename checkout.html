<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Vardhan's Wear</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        #message-box {
            display: none;
            position: fixed;
            top: 5rem;
            right: 1.5rem;
            background-color: white;
            padding: 1rem;
            border-radius: 0.375rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 100;
            border-left-width: 4px;
        }
        #pincode-spinner { display: none; }
        .address-card:has(input:checked) {
            border-color: #db2777; /* pink-600 */
            box-shadow: 0 0 0 2px #db2777;
        }
        #page-loader {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding-top: 10rem;
        }
        .spinner {
            border: 4px solid #f9a8d4; /* pink-200 */
            border-top: 4px solid #db2777; /* pink-600 */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <link rel="manifest" href="/manifest.json">
</head>
<body class="bg-gray-50">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-gray-800">Vardhan Wears</a>
            <div class="flex items-center space-x-4">
                <a href="cart.html" class="p-2 text-gray-600 hover:text-gray-900">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="sr-only">Cart</span>
                </a>
                <a href="index.html" class="hidden md:block text-gray-600 hover:text-gray-900 font-medium">Home</a>
                <div class="relative hidden md:block">
                    <button onclick="toggleDesktopMenu()" id="desktop-menu-btn" class="text-gray-800 focus:outline-none text-xl p-2 rounded-md hover:bg-gray-100">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div id="desktop-menu-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-50 border border-gray-200">
                        </div>
                </div>
                <div class="md:hidden">
                    <button id="menu-btn" class="text-gray-800 focus:outline-none">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>
            </div>
        </nav>
        <div id="mobile-nav-links" class="md:hidden hidden bg-white">
            </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 mt-8 pb-16">
        
        <div id="page-loader">
            <div class="spinner"></div>
            <p class="text-xl font-medium mt-4 text-gray-600">Loading Checkout...</p>
        </div>

        <div id="checkout-content" class="hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Checkout</h1>
            
            <div class="lg:grid lg:grid-cols-3 lg:gap-8">
                
                <section class="lg:col-span-2 space-y-6">
                    
                    <div class="bg-gradient-to-b from-white to-pink-50 rounded-lg shadow-lg p-6 border border-pink-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">1. Select a Shipping Address</h2>
                        <div id="saved-address-list" class="space-y-4">
                            <p class="text-gray-500">Loading saved addresses...</p>
                        </div>
                        <div class="mt-4">
                            <label for="add-new-address-radio" class="flex items-center p-4 border border-gray-200 rounded-lg cursor-pointer address-card bg-white">
                                <input type="radio" id="add-new-address-radio" name="addressSelection" class="h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500">
                                <span class="ml-3 font-medium text-gray-700">Add a New Address</span>
                            </label>
                        </div>
                    </div>

                    <div id="new-address-form-container" class="hidden bg-gradient-to-b from-white to-pink-50 rounded-lg shadow-lg p-6 border border-pink-100">
                        <h2 class="text-2xl font-bold text-gray-900 mb-4">Add New Address</h2>
                        <form id="shipping-form" class="space-y-4">
                            <div>
                                <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
                                <input type="text" id="fullName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="countryCode" class="block text-sm font-medium text-gray-700">Code</label>
                                    <input type="text" id="countryCode" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-gray-100" value="+91" readonly>
                                </div>
                                <div class="md:col-span-2">
                                    <label for="phone" class="block text-sm font-medium text-gray-700">Phone Number (10-digit)</label>
                                    <input type="tel" id="phone" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required pattern="[0-9]{10}" title="Please enter a 10-digit phone number">
                                </div>
                            </div>

                            <div>
                                <label for="address" class="block text-sm font-medium text-gray-700">Street Address</label>
                                <input type="text" id="address" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label for="postalCode" class="flex items-center text-sm font-medium text-gray-700">
                                        <span>Postal Code</span>
                                        <i id="pincode-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                                    </label>
                                    <input type="text" id="postalCode" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2" required maxlength="6">
                                </div>
                                <div>
                                    <label for="city" class="block text-sm font-medium text-gray-700">City</label>
                                    <input type="text" id="city" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-gray-50" required>
                                </div>
                                <div>
                                    <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                                    <input type="text" id="state" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-gray-50" required>
                                </div>
                            </div>
                            <div>
                                <label for="country" class="block text-sm font-medium text-gray-700">Country</label>
                                <input type="text" id="country" value="India" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2 bg-gray-50" readonly>
                            </div>
                            <div class="flex items-center">
                                <input id="save-address-checkbox" type="checkbox" class="h-4 w-4 text-pink-600 border-gray-300 rounded focus:ring-pink-500">
                                <label for="save-address-checkbox" class="ml-2 block text-sm text-gray-900">Save this address for future orders</label>
                            </div>
                        </form>
                    </div>
                </section>
                
                <section class="lg:col-span-1 mt-8 lg:mt-0">
                    <div class="bg-gradient-to-b from-white to-pink-50 rounded-lg shadow-lg p-6 sticky top-24 border border-pink-100">
                        <h2 class="text-xl font-semibold text-gray-900 border-b border-pink-200 pb-4">Order Summary</h2>
                        <div id="summary-items-list" class="space-y-4 mt-4 max-h-60 overflow-y-auto border-b border-pink-200 pb-4">
                            </div>
                        <div class="space-y-2 mt-4">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Subtotal</span>
                                <span id="summary-subtotal" class="font-medium text-gray-900">₹0.00</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Shipping</span>
                                <span id="summary-shipping" class="font-medium text-gray-900">₹0.00</span>
                            </div>
                            <p id="shipping-note" class="text-xs text-pink-600 font-medium text-right -mt-1">Free shipping on orders over ₹2000.00</p>
                            
                            <div class="flex justify-between border-t border-pink-200 pt-4 mt-2">
                                <span class="text-lg font-bold text-gray-900">Total</span>
                                <span id="summary-total" class="text-lg font-bold text-gray-900">₹0.00</span>
                            </div>
                        </div>
                        <button id="pay-now-btn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 mt-6 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Pay Now
                        </button>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <div id="message-box">
        <p id="message-text" class="font-medium"></p>
    </div>

    <script>
        // =================== DEPLOYMENT FIX: Add API_URL ===================
        const API_URL = 'https://vardhan-wears-api.onrender.com';
        // ===================================================================

        // --- Global State ---
        let cart = []; // This will be the *validated* cart
        let subtotal = 0;
        let shippingCost = 0; 
        let total = 0;
        const token = localStorage.getItem('token');
        let currentUser = null;
        let savedAddresses = []; 

        // --- Menu Toggles ---
        const menuBtn = document.getElementById('menu-btn');
        const mobileNavLinks = document.getElementById('mobile-nav-links'); 
        menuBtn.addEventListener('click', () => { mobileNavLinks.classList.toggle('hidden'); });
        function toggleDesktopMenu() { document.getElementById('desktop-menu-dropdown').classList.toggle('hidden'); }
        window.onclick = function(event) {
            if (!event.target.matches('#desktop-menu-btn') && !event.target.closest('#desktop-menu-btn')) {
                const dropdown = document.getElementById('desktop-menu-dropdown');
                if (dropdown && !dropdown.classList.contains('hidden')) {
                    dropdown.classList.add('hidden');
                }
            }
        }
        // Make sure it's globally accessible
        window.toggleDesktopMenu = toggleDesktopMenu;

        // --- Auth & Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // ===============================================
            // === PWA SERVICE WORKER REGISTRATION START ===
            // ===============================================
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('Service Worker registered successfully:', registration);
                    })
                    .catch((error) => {
                        console.error('Service Worker registration failed:', error);
                    });
            }
            // ===============================================
            // === PWA SERVICE WORKER REGISTRATION END ===
            // ===============================================

            const authed = await checkAuth();
            if (authed) {
                await initializeCheckout();
            }
        });

        async function checkAuth() {
            const desktopDropdown = document.getElementById('desktop-menu-dropdown');
            const mobileNav = document.getElementById('mobile-nav-links'); // Get mobile nav
            
            let desktopLinks = '';
            let mobileLinks = '';

            // --- === CHANGED: Desktop links now point to correct pages === ---
            // === START OF CHANGES ===
            desktopLinks = `
                <a href="shop.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Shop</a>
                <a href="index.html#about" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">About</a>
                <a href="index.html#contact" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Contact</a>
                <hr class="my-1 border-gray-100">
            `;
            
            // --- === CHANGED: Mobile links now include parent categories and correct paths === ---
            mobileLinks = `
                <a href="index.html" class="block py-2 px-6 text-sm text-gray-700 hover:bg-gray-100">Home</a>
                <hr class="my-1 border-gray-100">
                <a href="shop.html" class="block py-2 px-6 text-sm text-blue-600 font-medium hover:bg-gray-100">Shop</a>
                <hr class="my-1 border-gray-100">
                <a href="index.html#about" class="block py-2 px-6 text-sm text-gray-700 hover:bg-gray-100">About</a>
                <a href="index.html#contact" class="block py-2 px-6 text-sm text-gray-700 hover:bg-gray-100">Contact</a>
                <hr class="my-1 border-gray-100">
            `;
            // === END OF CHANGES ===


            if (!token) {
                showMessage('You must be logged in to check out.', 'error');
                setTimeout(() => window.location.href = `login.html?redirect=checkout.html`, 2000);
                return false;
            }
            try {
                // =================== DEPLOYMENT FIX: Use API_URL ===================
                const res = await fetch(`${API_URL}/api/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                // ===================================================================
                if (!res.ok) {
                    localStorage.removeItem('token');
                    checkAuth(); 
                    return false;
                }
                currentUser = await res.json();
                document.getElementById('fullName').value = currentUser.name || '';
                
                // --- Links for logged-in user (Logout is intentionally omitted here) ---
                desktopLinks += `
                        <a href="profile.html" class="flex items-center px-4 py-2 text-sm text-blue-600 font-medium hover:bg-gray-100">
                            <i class="fas fa-user-circle w-5 mr-2"></i> My Profile
                        </a>
                        ${currentUser.isAdmin ? '<a href="admin.html" class="block px-4 py-2 text-sm text-yellow-600 font-bold hover:bg-gray-100">Admin Panel</a>' : ''}
                `;
                mobileLinks += `
                        <a href="profile.html" class="flex items-center block py-2 px-6 text-sm text-blue-600 font-medium hover:bg-gray-100">
                            <i class="fas fa-user-circle w-5 mr-2"></i> My Profile
                        </a>
                        ${currentUser.isAdmin ? '<a href="admin.html" class="block py-2 px-6 text-sm text-yellow-600 font-bold hover:bg-gray-100">Admin Panel</a>' : ''}
                `;
                // --- End of links ---

            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('token');
                checkAuth();
                return false;
            }
            desktopDropdown.innerHTML = desktopLinks;
            mobileNav.innerHTML = mobileLinks; // Use correct variable
            return true;
        }

        // --- REMOVED: logout() function is no longer needed on this page ---

        // --- V3.1 Checkout Initialization & Validation ---

        async function initializeCheckout() {
            const loader = document.getElementById('page-loader');
            const content = document.getElementById('checkout-content');
            
            try {
                // =================== DEPLOYMENT FIX: Use API_URL ===================
                const res = await fetch(`${API_URL}/api/cart`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                // ===================================================================

                if (!res.ok) {
                    throw new Error('Failed to fetch your cart. Please try again.');
                }
                
                const data = await res.json();
                
                cart = data.items.filter(item => !item.isOutOfStock);
                
                const hasSufficientStock = cart.every(item => item.hasSufficientStock);
                
                if (cart.length === 0) {
                     showMessage('Your cart is empty. Redirecting to shopping.', 'error');
                     setTimeout(() => window.location.href = 'shop.html', 2000); // FIXED: Point to shop.html
                     return;
                }
                
                if (!hasSufficientStock) {
                    showMessage('Some items in your cart have quantity issues. Redirecting...', 'error');
                    setTimeout(() => window.location.href = 'cart.html', 3000);
                    return;
                }
                
                renderOrderSummary(cart);
                loadSavedAddresses();
                setupFormListeners();

                loader.style.display = 'none';
                content.classList.remove('hidden');
                document.getElementById('pay-now-btn').disabled = false; // Enable payment

            } catch (error) {
                console.error('Checkout initialization failed:', error);
                showMessage(error.message, 'error');
                loader.style.display = 'none';
            }
        }

        function renderOrderSummary(items) {
            const itemsContainer = document.getElementById('summary-items-list');
            itemsContainer.innerHTML = '';
            subtotal = 0;

            items.forEach(item => {
                subtotal += item.price * item.quantity;
                itemsContainer.innerHTML += `
                    <div class="flex items-center space-x-3">
                        <a href="product.html?id=${item.product}" class="flex-shrink-0">
                            <img src="${item.image}" alt="${item.name}" class="w-12 h-12 rounded-md object-cover hover:opacity-80 transition-opacity">
                        </a>
                        <div class="flex-1">
                            <a href="product.html?id=${item.product}" class="text-sm font-medium text-gray-900 hover:text-pink-600">${item.name}</a>
                            <p class="text-xs text-gray-500">Qty: ${item.quantity} (${item.size}, ${item.colorName})</p>
                        </div>
                        <span class="text-sm font-medium text-pink-600">₹${(item.price * item.quantity).toFixed(2)}</span>
                    </div>
                `;
            });

            shippingCost = (subtotal > 0 && subtotal < 2000) ? 50.00 : 0.00;
            total = subtotal + shippingCost;
            
            document.getElementById('summary-subtotal').textContent = `₹${subtotal.toFixed(2)}`;
            document.getElementById('summary-shipping').textContent = shippingCost === 0 ? 'Free' : `₹${shippingCost.toFixed(2)}`;
            document.getElementById('summary-total').textContent = `₹${total.toFixed(2)}`;
            document.getElementById('shipping-note').style.display = subtotal > 0 ? 'block' : 'none';
        }

        // --- Address & Pincode Logic ---

        function setupFormListeners() {
            document.getElementById('pay-now-btn').addEventListener('click', processPayment);
            document.getElementById('postalCode').addEventListener('input', handlePincode);
            
            document.getElementById('add-new-address-radio').addEventListener('change', () => {
                document.getElementById('new-address-form-container').classList.remove('hidden');
            });
        }
        
        async function loadSavedAddresses() {
            const addressList = document.getElementById('saved-address-list');
            try {
                // =================== DEPLOYMENT FIX: Use API_URL ===================
                const res = await fetch(`${API_URL}/api/auth/addresses`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                // ===================================================================
                if (!res.ok) throw new Error('Could not load addresses.');
                
                savedAddresses = await res.json();
                renderSavedAddresses(savedAddresses);
            } catch (error) {
                console.error('Error loading addresses:', error);
                addressList.innerHTML = '<p class="text-red-500">Could not load saved addresses.</p>';
            }
        }

        function renderSavedAddresses(addresses) {
            const addressList = document.getElementById('saved-address-list');
            const newAddressForm = document.getElementById('new-address-form-container');
            addressList.innerHTML = ''; 

            if (addresses.length === 0) {
                newAddressForm.classList.remove('hidden');
                document.getElementById('add-new-address-radio').checked = true;
            }

            addresses.forEach((addr, index) => {
                const isFirst = index === 0; 
                const addressCard = document.createElement('label');
                addressCard.htmlFor = `addr-${addr._id}`;
                addressCard.className = 'flex items-start p-4 border border-gray-200 rounded-lg cursor-pointer address-card bg-white';
                addressCard.innerHTML = `
                    <input type="radio" id="addr-${addr._id}" name="addressSelection" class="h-4 w-4 text-pink-600 border-gray-300 focus:ring-pink-500 mt-1" ${isFirst ? 'checked' : ''} value="${addr._id}">
                    <div class="ml-3">
                        <p class="font-bold text-gray-800">${addr.fullName}</p>
                        <p class="text-sm text-gray-600">${addr.address}</p>
                        <p class="text-sm text-gray-600">${addr.city}, ${addr.state} - ${addr.postalCode}</p>
                        <p class="text-sm text-gray-600">${addr.countryCode} ${addr.phone}</p>
                    </div>
                `;
                addressCard.addEventListener('change', () => {
                    newAddressForm.classList.add('hidden');
                });
                addressList.appendChild(addressCard);
            });
        }

        let pincodeTimer;
        function handlePincode(event) {
            const pincode = event.target.value;
            clearTimeout(pincodeTimer);
            if (pincode.length === 6) {
                const spinner = document.getElementById('pincode-spinner');
                spinner.classList.remove('hidden');
                pincodeTimer = setTimeout(() => {
                    fetchAddressFromPincode(pincode, spinner);
                }, 500);
            }
        }

        async function fetchAddressFromPincode(pincode, spinner) {
            try {
                const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`);
                if (!response.ok) throw new Error('Invalid Pincode');
                const data = await response.json();
                if (data[0].Status === 'Success' && data[0].PostOffice.length > 0) {
                    const postOffice = data[0].PostOffice[0];
                    document.getElementById('city').value = postOffice.District;
                    document.getElementById('state').value = postOffice.State;
                    document.getElementById('country').value = postOffice.Country;
                } else {
                    throw new Error('Pincode not found.');
                }
            } catch (error) {
                showMessage(error.message, 'error');
                document.getElementById('city').value = '';
                document.getElementById('state').value = '';
            } finally {
                if(spinner) spinner.classList.add('hidden');
            }
        }

        // --- Payment Logic ---
        async function processPayment() {
            let shippingAddress = null;

            // 1. Determine which address to use
            const selectedAddressId = document.querySelector('input[name="addressSelection"]:checked')?.value;
            const isAddNew = document.getElementById('add-new-address-radio').checked;
            
            if (selectedAddressId && !isAddNew) {
                shippingAddress = savedAddresses.find(addr => addr._id === selectedAddressId);
            } else if (isAddNew) {
                const shippingForm = document.getElementById('shipping-form');
                if (!shippingForm.checkValidity()) {
                    showMessage('Please fill out all required shipping fields.', 'error');
                    shippingForm.reportValidity();
                    return;
                }
                
                shippingAddress = {
                    fullName: document.getElementById('fullName').value,
                    countryCode: document.getElementById('countryCode').value,
                    phone: document.getElementById('phone').value,
                    address: document.getElementById('address').value,
                    postalCode: document.getElementById('postalCode').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    country: document.getElementById('country').value,
                };
                
                const saveAddressCheckbox = document.getElementById('save-address-checkbox');
                if (saveAddressCheckbox.checked) {
                    try {
                        // =================== DEPLOYMENT FIX: Use API_URL ===================
                        const saveRes = await fetch(`${API_URL}/api/auth/addresses`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                            body: JSON.stringify(shippingAddress)
                        });
                        // ===================================================================
                        if (!saveRes.ok) {
                            const err = await saveRes.json();
                            showMessage(`Could not save new address: ${err.message}`, 'error');
                        }
                    } catch (err) {
                        console.error("Failed to save address:", err);
                        showMessage("Could not save new address, but proceeding with payment.", "info");
                    }
                }
            } else {
                showMessage('Please select or add a shipping address.', 'error');
                return;
            }

            // 2. Prepare Order Data (using the *validated* cart)
            const orderItems = cart.map(item => ({
                product: item.product, 
                name: item.name,
                quantity: item.quantity,
                price: item.price,
                image: item.image,
                size: item.size,
                colorName: item.colorName,
            }));
            const orderData = { orderItems, shippingAddress, totalPrice: total };

            const payButton = document.getElementById('pay-now-btn');
            payButton.disabled = true;
            payButton.textContent = 'Processing...';

            try {
                // 3. Create Order in Backend
                // =================== DEPLOYMENT FIX: Use API_URL ===================
                const createOrderRes = await fetch(`${API_URL}/api/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(orderData)
                });
                // ===================================================================

                if (!createOrderRes.ok) {
                    const err = await createOrderRes.json();
                    throw new Error(err.message || 'Failed to create order on server.');
                }
                
                const { orderId, razorpayOrderId, amount, currency, key } = await createOrderRes.json();
                
                // 4. Open Razorpay Modal
                const options = {
                    key: key,
                    amount: amount,
                    currency: currency,
                    name: "Vardhan's Wear",
                    description: `Order ID: ${orderId}`,
                    order_id: razorpayOrderId,
                    handler: async function (response) {
                        // 5. Payment was successful, now verify it
                        await verifyPayment(response, orderId);
                    },
                    prefill: {
                        name: currentUser.name,
                        email: currentUser.email,
                        contact: shippingAddress.phone
                    },
                    theme: { color: "#db2777" }
                };
                
                const rzp = new Razorpay(options);
                rzp.on('payment.failed', function (response) {
                    console.error(response);
                    showMessage(`Payment failed: ${response.error.description}`, 'error');
                    payButton.disabled = false;
                    payButton.textContent = 'Pay Now';
                });

                rzp.open(); // Show the payment modal

            } catch (error) {
                console.error('Error processing payment:', error);
                showMessage(error.message, 'error');
                payButton.disabled = false;
                payButton.textContent = 'Pay Now';
            }
        }

        async function verifyPayment(paymentResponse, ourOrderId) {
            try {
                const verificationData = {
                    razorpay_order_id: paymentResponse.razorpay_order_id,
                    razorpay_payment_id: paymentResponse.razorpay_payment_id,
                    razorpay_signature: paymentResponse.razorpay_signature, // Corrected typo from user's code
                    order_id: ourOrderId 
                };

                // =================== DEPLOYMENT FIX: Use API_URL ===================
                const verifyRes = await fetch(`${API_URL}/api/orders/verify`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(verificationData)
                });
                // ===================================================================

                if (!verifyRes.ok) {
                    const err = await verifyRes.json();
                    throw new Error(err.message || 'Payment verification failed.');
                }

                showMessage('Payment successful! Redirecting...', 'success');
                
                // =================== DEPLOYMENT FIX: Use API_URL ===================
                await fetch(`${API_URL}/api/cart/clear`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                // ===================================================================
                
                setTimeout(() => {
                    window.location.href = `order-details.html?id=${ourOrderId}`; 
                }, 2000);

            } catch (error) {
                console.error('Error verifying payment:', error);
                showMessage(error.message, 'error');
                document.getElementById('pay-now-btn').disabled = false;
                document.getElementById('pay-now-btn').textContent = 'Pay Now';
            }
        }

        // --- Message Box ---
        function showMessage(message, type = 'success') {
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageBox.style.borderLeftColor = type === 'error' ? '#ef4444' : '#10b981';
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }
    </script>
    <script src="//code.tidio.co/dfexxakczw7qvenssz4ma5d28igwxnrq.js" async></script>
</body>
</html>